#!/usr/bin/node

"use strict";

const fs = require('fs');
const esprima = require('esprima');
const APIUseWalker = require('./APIUseWalker');
const colors = require('colors');
const crypto = require('crypto');



function forEachJSFileRecursive(path, callback) {
  if (!path.endsWith('/')) { path += '/' }

  const files = fs.readdirSync(path);
  files.forEach(file => {
    const stats = fs.statSync(path + file);
    if (stats.isDirectory()) {
      forEachJSFileRecursive(path + file, callback);
    } else if (file.endsWith('.js')) {
      const contents = fs.readFileSync(path + file, 'utf-8');
      callback(path + file, contents);
    }
  });
}

function mergeUses(a, b) {
  const bCallees = Object.getOwnPropertyNames(b);
  bCallees.forEach(callee => {
    if (a.hasOwnProperty(callee)) {
      const aAuthors = Object.getOwnPropertyNames(a[callee]);
      const bAuthors = Object.getOwnPropertyNames(b[callee]);
      bAuthors.forEach(author => {
        if (aAuthors.indexOf(author) > -1) {
          a[callee][author] += b[callee][author];
        } else {
          a[callee][author] = b[callee][author];
        }
      });
    } else {
      a[callee] = b[callee];
    }
  });
  return a;
}

// Retrieves the AST of the given file contents
// A cached AST will be returned if available
// If not, the contents will be parsed and the resulting AST will be cached
function getAst(contents) {
  const checksum = crypto
        .createHash('md5')
        .update(contents, 'utf8')
        .digest('hex');
  const cacheFile = `./.cache/${checksum}`;
  if (fs.existsSync(cacheFile)) {
    return JSON.parse(fs.readFileSync(cacheFile))
  }

  try {
    let ast = esprima.parse(contents, { loc: true, tolerant: true });
    fs.writeFileSync(cacheFile, JSON.stringify(ast));
    return ast;
  } catch(err) {
    console.error('Could not parse!');
    console.dir(err);
    return null;
  }
}



const repo = process.argv[2];
const globalUses = {};

forEachJSFileRecursive(repo, function(filename, contents) {
  console.log(filename.green);
  let ast = getAst(contents);

  const walker = new APIUseWalker(repo, filename);
  walker.handleNode(ast);
  walker.finalize();
  mergeUses(globalUses, walker._uses);
});

console.dir(globalUses, { colors: true, depth: null });
